<!DOCTYPE html>
<html>
<head>
	<title>Instafari</title>
	<script src="jquery-1.4.2.min.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript" charset="utf-8">
	var instapaperAddURL = "https://www.instapaper.com/api/add";
	
	var toolbarIconDelay = 2500;
	
	function flashToolbarIcon(toolbarItem, iconPath) {
    toolbarItem.image = safari.extension.baseURI + iconPath;
    setTimeout(function(){
      toolbarItem.image = safari.extension.baseURI + "readlater-icon.png";
    }, toolbarIconDelay);
  }
  
  function setAllToolbarToolTips(text) {
	  if (text == "") {
	    text = "Read Later";
	  }
	  
	  jQuery.each(safari.extension.toolbarItems, function(i, ti){
	    if(ti.command === "readlater") {
	      ti.toolTip = text;
	    }
	  });
	}
	
	function setAllToolbarButtonsDisabled(disabled) {
	  jQuery.each(safari.extension.toolbarItems, function(i, ti){
	    if(ti.command === "readlater") {
	      if (disabled == false) {
	        if (ti.browserWindow) {
  	        ti.disabled = !ti.browserWindow.activeTab.url;
  	      } else {
  	        ti.disabled = false;
  	      }
	      } else {
	        ti.disabled = true
	      }
	    }
	  });
	}
	
	function checkSettings() {
	  if (safari.extension.settings.username) {
      setAllToolbarToolTips("");
      setAllToolbarButtonsDisabled(false);
    } else {
      setAllToolbarToolTips("Please enter your username and password in Instafari's preferences area.");
      setAllToolbarButtonsDisabled(true);
    }
	}
	
	function commandListener(event) {
	  var activeTab = event.target.browserWindow.activeTab;
	  
	  if (event.command === "readlater") {
	    var params = {
	           url: activeTab.url,
	         title: activeTab.title,
	      username: safari.extension.settings.username,
	      password: safari.extension.secureSettings.password
	    };
	    
	    var postSucceed = function(){
	      flashToolbarIcon(event.target, "readlater-icon-success.png");
	      console.log("success!");
	    }
	    
	    var postError = function(xhr, errorType, exception){
	      flashToolbarIcon(event.target, "readlater-icon-fail.png");
	      console.log("failure: ", xhr, errorType, exception);
	      if(xhr.status == 403) {
      		alert("The credentials you entered in the preferences have been denied. Please check your Instapaper credentials in the preferences.");
          } else if (xhr.status == 500 || xhr.status == 404) {
	        alert("Server error occured on Instapaper's end. Please try again.");
          }
          
	    }
	    
	    jQuery.ajax({
	         type: 'POST',
	          url: instapaperAddURL,
	         data: params,
	      success: postSucceed,
	        error: postError
	    });
	    
	  }
	}
	
	function validateListener(event) {
    checkSettings();
	}
	
	checkSettings();
	
	safari.application.addEventListener("command", commandListener, false);
	safari.application.addEventListener("validate", validateListener, false);
	safari.application.addEventListener("change", checkSettings, false);	 
	</script>
</head>
<body>
</body>
</html>
